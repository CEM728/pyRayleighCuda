
force_update_tstart=0;

db = 'C:\Users\Vandiver\Data\sonalleve\sonalleve.db';

% Order is single followed by multi

files_to_compare = {...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_14_1.PAR',...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_13_1.PAR',...
    'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_11_1.PAR'...
    'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_12_1.PAR'...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_7_1.PAR',...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_6_1.PAR'...
    };

%single vs triangular sweep, 20W & 30W
% files_to_compare = {...
%     'QA_phantom_20150621\Caskey_999_11_01_15.14.59_(TemperatureMapping_CLEAR).PAR',...
%     'QA_phantom_20150621\Caskey_999_08_01_14.49.12_(TemperatureMapping_CLEAR).PAR',...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_7_1.PAR',...
%     'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_6_1.PAR'...
%    };
% 
% files_to_compare = {...
%     'Grissom_8888_WIP_TemperatureMapping_CLEAR_4_1.PAR',...
%     'Grissom_8888_WIP_TemperatureMapping_CLEAR_3_1.PAR',...
%     'Caskey_20150926_WIP_TMap_Sing_40W_CLEAR_5_1.PAR',...
%     'Caskey_20150926_WIP_TMap_Mult_40W_CLEAR_6_1.PAR' ...
%    };

%paramset A
files_to_compare = {...
    'Caskey_20150926_WIP_TMap_Sing_60W_CLEAR_4_1.PAR',...
    'Caskey_20150926_WIP_TMap_Mult_60W_CLEAR_3_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_11_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_9_1.PAR',...
    'Caskey_20150926_WIP_TMap_Sing_40W_CLEAR_5_1.PAR',...
    'Caskey_20150926_WIP_TMap_Mult_40W_CLEAR_6_1.PAR', ...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_6_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_5_1.PAR',...
    'Grissom_8888_WIP_TemperatureMapping_CLEAR_4_1.PAR',...
    'Grissom_8888_WIP_TemperatureMapping_CLEAR_3_1.PAR'...
   };

%paramset A 60W
files_to_compare = {...
    'Caskey_20150926_WIP_TMap_Sing_60W_CLEAR_4_1.PAR',...
    'Caskey_20150926_WIP_TMap_Mult_60W_CLEAR_3_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_11_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_9_1.PAR',...
   };
% %paramset A 40W
files_to_compare = {...
    'Caskey_20150926_WIP_TMap_Sing_40W_CLEAR_5_1.PAR',...
    'Caskey_20150926_WIP_TMap_Mult_40W_CLEAR_6_1.PAR', ...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_6_1.PAR',...
    'Caskey_20150924_WIP_TemperatureMapping_CLEAR_5_1.PAR',...
    'Grissom_8888_WIP_TemperatureMapping_CLEAR_4_1.PAR',...
    'Grissom_8888_WIP_TemperatureMapping_CLEAR_3_1.PAR',...
   };



%files_to_compare={'QA_phantom_20150628\Caskey_9999_WIP_TemperatureMapping_CLEAR_7_1.PAR'};
dbid = mksqlite(0,'open',db);

figure(2);
clf;
hold on;
xlabel('sec');
ylabel('\Delta T (^oC) / mL');

plotObjs=[];

for fn=1:length(files_to_compare)

    [fdir,fbase,fext]=fileparts(files_to_compare{fn});
    query = sprintf('select * from data where file="%s%s";',fbase,fext)
    qrydata = mksqlite(dbid, query);
    
    
    [ deltaTseries, axis0_mm, axis1_mm, slice_axis_mm, dyntimes, im ] = GetDeltaTemp4D_PAR( [qrydata.path,'\',qrydata.file], qrydata.isRI, 0.01 );


    
    
    dTroi = deltaTseries(qrydata.start0:qrydata.end0, qrydata.start1:qrydata.end1, qrydata.start2:qrydata.end2, :);
    sz=size(dTroi);
    flattened = reshape(dTroi,sz(1)*sz(2)*sz(3),sz(4));
    
    roiNvox =  prod(sz(1:3));
    roiVol_ml = prod(sz(1:3).*im.Spc(1:3))*1e-3;
    
    avgTemp = mean(flattened,1);
    %avgTemp = max(flattened);
    %avgTemp_per_ml = sum(flattened,1) / roiVol_ml;
    %avgTemp_per_ml = squeeze( sum(sum(sum(dTroi,1),2),3) ) / roiVol_ml;
    
    sthresh = find( cumsum(avgTemp) > .5 ) - 1;
    t0idx = sthresh(1)-1;
    if t0idx == 0
        t0idx = 1;
    end
    disp(sthresh(1)-1)
    if force_update_tstart || (~isfield(qrydata,'tstartidx')) || length(qrydata.tstartidx)==0
        disp([fbase fext ' no tstart'])
        query = sprintf('update data set tstart=%f, tstartidx=%d where file="%s%s";',dyntimes(t0idx), t0idx,fbase,fext)
        mksqlite(dbid, query)
    else
        t0idx = qrydata.tstartidx;
    end
    
    
    im.Spc
    pl = plot( dyntimes- dyntimes(t0idx), avgTemp, 'DisplayName', [fbase sprintf(' %f ml, N=%d',roiVol_ml, roiNvox)] );
    
    if mod(fn,2) 
        set(pl,'LineStyle','--');
    else
        color=get(plprev,'Color'); 
        set(pl,'Color', color);
    end
    
    plprev=pl;
    plotObjs(end+1)=plprev;
end
mksqlite(dbid,'close');

leg=legend(plotObjs);
set(leg,'Interpreter', 'None', 'Location', 'Northwest');

